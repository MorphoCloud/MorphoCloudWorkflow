name: Send Renewal Email

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number"
        required: true
      days_until_expiration:
        description: "Number of days before deletion"
        required: true

permissions:
  issues: write
  checks: read

jobs:
  send-renewal-email:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6

      - name: Define instance name
        id: define
        uses: ./.github/actions/define-instance-name
        with:
          prefix: ${{ vars.INSTANCE_NAME_PREFIX }}
          issue_number: ${{ inputs.issue_number }}

      - name: Check instance exists
        id: check_instance
        uses: ./.github/actions/check-instance-exists
        with:
          os_cloud: ${{ vars.MORPHOCLOUD_OS_CLOUD }}
          instance_name: ${{ steps.define.outputs.instance_name }}

      - name: command results comment (Instance does not exist)
        if: ${{ steps.check_instance.outputs.exists == 'false' }}
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          issue-number: ${{ inputs.issue_number }}
          body: |
            ‚ùå **Renewal email not sent**: Instance **${{ steps.define.outputs.instance_name }}** does not exist.

            See details at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Define volume name
        id: define_volume_name
        uses: ./.github/actions/define-volume-name
        with:
          issue_number: ${{ inputs.issue_number }}
          suffix: ${{ vars.VOLUME_NAME_SUFFIX }}

      - name: Extract fields
        id: extract
        uses: ./.github/actions/extract-issue-fields
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue_number: ${{ inputs.issue_number }}

      - name: Check if email is encoded
        id: check_email_encryption
        shell: bash
        run: |
          if [[ "$EMAIL" != *"@"* ]]; then
            encoded="true"
          else
            encoded="false"
          fi
          echo "encoded=$encoded" >> $GITHUB_OUTPUT
        env:
          EMAIL: ${{ steps.extract.outputs.email }}

      - name: Decode email
        id: decode_email
        uses: ./.github/actions/encode-decode-string
        with:
          input_string: ${{ steps.extract.outputs.email }}
          encryption_key: ${{ secrets.STRING_ENCRYPTION_KEY }}
          operation: "decode"
          skip: ${{ steps.check_email_encryption.outputs.encoded == 'false' }}

      - name: Check renewal availability
        id: check_renewal
        shell: bash
        run: |
          # Retrieve issue labels
          issue_json=$(gh issue view "$ISSUE_NUMBER" --json labels)
          labels=$(echo "$issue_json" | jq -r '.labels[].name')

          # Extract expiration labels (e.g., expiration:60d, expiration:120d)
          lifespan_list=$(echo "$labels" | grep -oP '(?<=expiration:)\d+(\.\d+)?' | sort -n)

          # Count available expiration labels
          expiration_count=$(echo "$lifespan_list" | wc -l)

          # Retrieve the highest existing renewal count (e.g., renewed:1, renewed:2)
          renewed_count=$(echo "$labels" | grep -oP '(?<=renewed:)\d+' | sort -nr | head -n1)
          renewed_count=${renewed_count:-0}  # Default to 0 if not found

          echo "Expiration count: $expiration_count"
          echo "Renewed count: $renewed_count"

          # Check if renewal is still available
          # Renewal is available if renewed_count + 1 < expiration_count
          if [[ $((renewed_count + 1)) -lt $expiration_count ]]; then
            renewal_available="true"
          else
            renewal_available="false"
          fi

          echo "Renewal available: $renewal_available"
          echo "renewal_available=$renewal_available" >> $GITHUB_OUTPUT
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Send renewal email (renewal available)
        id: send_email_renewable
        if: ${{ steps.check_renewal.outputs.renewal_available == 'true' }}
        uses: dawidd6/action-send-mail@6d98ae34d733f9a723a9e04e94f2f24ba05e1402 # v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          from: MorphoCloudPortal
          to: ${{ steps.decode_email.outputs.output_string }}
          subject:
            "[${{ github.event.repository.name }}] Instance ${{
            steps.define.outputs.instance_name }} and Volume ${{
            steps.define_volume_name.outputs.volume_name }} Scheduled for
            Deletion"
          convert_markdown: true
          html_body: |
            ## üö® Urgent: Your MorphoCloud Instance & Volume Will Be Deleted in ${{ inputs.days_until_expiration }} Days

            Your MorphoCloud instance **${{ steps.define.outputs.instance_name }}** and its associated volume **${{ steps.define_volume_name.outputs.volume_name }}** are scheduled for **permanent deletion** in **${{ inputs.days_until_expiration }}** days.

            **This action is irreversible.** If you need to retain your instance and volume, you **must renew before the deadline** by commenting `/renew` on [Issue #${{ inputs.issue_number }}](https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }}).

            ## üîÑ How to Renew
            1Ô∏è‚É£ Open [Issue #${{ inputs.issue_number }}](https://github.com/${{ github.repository }}/issues/${{ inputs.issue_number }})
            2Ô∏è‚É£ Add a new comment: **`/renew`**
            3Ô∏è‚É£ If additional lifespan is available, your instance will be extended.

            **üî¥ If no renewal is requested, your instance and volume will be permanently deleted in ${{ inputs.days_until_expiration }} days.**

            ## ‚ùì Need Help?

            Contact us at [morphocloud@outlook.com](mailto:morphocloud@outlook.com) if you have any questions.

            **‚è≥ Time is running out! If you wish to keep your instance and volume, comment `/renew` now!**

      - name: Send final expiration email (no renewal available)
        id: send_email_final
        if: ${{ steps.check_renewal.outputs.renewal_available == 'false' }}
        uses: dawidd6/action-send-mail@6d98ae34d733f9a723a9e04e94f2f24ba05e1402 # v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          from: MorphoCloudPortal
          to: ${{ steps.decode_email.outputs.output_string }}
          subject:
            "[${{ github.event.repository.name }}] FINAL NOTICE: Instance ${{
            steps.define.outputs.instance_name }} and Volume ${{
            steps.define_volume_name.outputs.volume_name }} Will Be Deleted"
          convert_markdown: true
          html_body: |
            ## üö® FINAL NOTICE: Your MorphoCloud Instance & Volume Will Be Permanently Deleted in ${{ inputs.days_until_expiration }} Days

            Your MorphoCloud instance **${{ steps.define.outputs.instance_name }}** and its associated volume **${{ steps.define_volume_name.outputs.volume_name }}** are scheduled for **permanent deletion** in **${{ inputs.days_until_expiration }}** days.

            **‚ö†Ô∏è IMPORTANT: This instance has already been renewed and NO FURTHER RENEWALS ARE POSSIBLE.**

            **This action is irreversible.** Please ensure you:
            1. **Back up all important data immediately** from your instance and volume
            2. Download any files or results you need to keep

            **üî¥ Your instance and volume will be permanently deleted in ${{ inputs.days_until_expiration }} days. There is no way to extend this deadline.**

            ## üÜï Need a New Instance?

            After your current instance is deleted, you can request a new instance by opening a new issue in this repository.

            ## ‚ùì Need Help?

            Contact us at [morphocloud@outlook.com](mailto:morphocloud@outlook.com) if you have any questions.

            **‚è≥ Time is running out! Back up your data now!**

      - name: command results comment (failed)
        if: ${{ (steps.send_email_renewable.outcome == 'failure' || steps.send_email_final.outcome == 'failure') && failure() }}
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          issue-number: ${{ inputs.issue_number }}
          body: |
            ‚ùå Failed to send renewal email for **${{ steps.define.outputs.instance_name }}**.

            See details at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: command results comment (success)
        if: ${{ (steps.send_email_renewable.outcome == 'success' || steps.send_email_final.outcome == 'success') && success() }}
        uses: peter-evans/create-or-update-comment@v5.0.0
        with:
          issue-number: ${{ inputs.issue_number }}
          body: |
            ‚úÖ Successfully sent ${{ steps.check_renewal.outputs.renewal_available == 'true' && 'renewal' || 'final expiration' }} email for **${{ steps.define.outputs.instance_name }}**.
