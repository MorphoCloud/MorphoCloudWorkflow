name: Automatic Instance Deleting
on:
  schedule:
    # Run once per day
    - cron: "0 0 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ vars.MORPHOCLOUD_OS_CLOUD }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  auto-delete:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6
        with:
          clean: true

      - uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: app-token
        with:
          app-id: ${{ vars.MORPHOCLOUD_WORKFLOW_APP_ID }}
          private-key: ${{ secrets.MORPHOCLOUD_WORKFLOW_APP_PRIVATE_KEY }}

      - name: Retrieve and process instance deletion candidates
        run: |
          source ~/venv/bin/activate

          instance_prefix=${PREFIX:+${PREFIX}_}
          instance_basename="${instance_prefix}instance"

          # Retrieve all instances matching the basename pattern
          openstack server list --name "^${instance_basename}-\\d+" -f json | \
          jq -c '.[]' | while read -r instance_json; do
            instance_name=$(echo "$instance_json" | jq -r '.Name')

            # Extract the issue number from the instance name
            issue_number=${instance_name##*-}  # Extract issue number

            # Retrieve issue creation date from GitHub
            issue_json=$(gh issue view "$issue_number" --json createdAt)
            created_at=$(echo "$issue_json" | jq -r '.createdAt')

            # Convert ISO 8601 timestamp to epoch time
            created_at_epoch=$(date -d "$created_at" +%s)

            current_time_epoch=$(date +%s)
            lifespan_days=$(( (current_time_epoch - created_at_epoch) / 86400 ))

            # Retrieve issue labels
            issue_json=$(gh issue view "$issue_number" --json labels)
            labels=$(echo "$issue_json" | jq -r '.labels[].name')

            # Retrieve lifespan values from labels
            lifespan_list=$(echo "$labels" | grep -oP '(?<=expiration:)\d+(\.\d+)?' | sort -n)
            max_lifespan=$(echo "$lifespan_list" | tail -n1)

            # Skip if issue is not associated with any "expiration" labels.
            if [[ -n "$lifespan_list" ]]; then
              # Retrieve renewal values from labels.
              renewed_count=$(echo "$labels" | grep -oP '(?<=renewed:)\d+' | sort -nr | head -n1)
              renewed_count=${renewed_count:-0}  # Default to 0 if not found

              # Compute expiration time
              expiration_days=$(echo "$lifespan_list" | sed -n "$((renewed_count + 1))p")
              expiration_days=${expiration_days:-0}
              # Use bc for floating-point arithmetic support
              expiration_time_epoch=$(printf "%.0f" $(echo "$created_at_epoch + $expiration_days * 86400" | bc))

              # Calculate time remaining in seconds (not days) for accurate comparison
              seconds_until_expiration=$((expiration_time_epoch - current_time_epoch))
              days_until_expiration=$((seconds_until_expiration / 86400))

              echo "Instance: [$instance_name], Created: [$created_at], Lifespan: [$lifespan_days days], Expiration: [$expiration_days days], Days left: [$days_until_expiration], Seconds left: [$seconds_until_expiration]"

              # Only delete if expiration time has actually passed (seconds <= 0)
              if [[ "$seconds_until_expiration" -le 0 ]]; then
                echo "Instance ${instance_name} has expired. Deleting..."

                # Delete volume first inline, then instance (no grace period)
                # Volume name uses optional suffix from VOLUME_NAME_SUFFIX variable
                volume_suffix=${SUFFIX:+-${SUFFIX}}
                volume_name="My-Data-${issue_number}${volume_suffix}"
                echo "Volume name: $volume_name"

                # Check if volume exists
                volume_id=$(openstack volume list -f json | \
                  jq --arg volume_name "$volume_name" \
                  -r '.[] | select(.Name == $volume_name) | .ID' | tail -1)

                if [[ -n "$volume_id" ]]; then
                  echo "Found volume: $volume_id"

                  # Check if volume is attached to instance
                  instance_id=$(openstack server list -f json | \
                    jq --arg instance_name "$instance_name" \
                    -r '.[] | select(.Name == $instance_name) | .ID' | tail -1)

                  if [[ -n "$instance_id" ]]; then
                    is_attached=$(openstack server show "$instance_id" -f json | \
                      jq --arg volume_id "$volume_id" \
                      '[.volumes_attached[]?.id] | index($volume_id) != null')

                    if [[ "$is_attached" == "true" ]]; then
                      echo "Detaching volume from instance..."
                      if openstack server remove volume "$instance_id" "$volume_id"; then
                        echo "Waiting 60 seconds for volume to become available..."
                        sleep 60
                      else
                        echo "::warning ::Failed to detach volume $volume_name from $instance_name"
                      fi
                    fi
                  fi

                  # Delete the volume
                  echo "Deleting volume..."
                  if openstack volume delete "$volume_id"; then
                    echo "Volume $volume_name deleted successfully"
                    gh issue edit "$issue_number" --add-label "volume:deleted" --remove-label "volume:expiration-pending" || true
                    gh issue comment "$issue_number" --body "Volume **${volume_name}** successfully deleted ✅"
                  else
                    echo "::warning ::Failed to delete volume $volume_name"
                    gh issue comment "$issue_number" --body "❌ Failed to delete volume **${volume_name}**. See details at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  fi
                else
                  echo "Volume $volume_name does not exist, skipping volume deletion"
                fi

                # Delete instance
                set +e
                gh workflow run control-instance-from-workflow.yml \
                  -f issue_number=$issue_number \
                  -f command_name=delete \
                  -f unapprove_after_delete=true
                error_code=$?
                set -e
                if [[ $error_code -ne 0 ]]; then
                  echo "::warning ::Failed to run workflow for deleting $instance_name."
                  gh issue comment "$issue_number" \
                    --body "❌ Failed to delete instance. See details at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  continue
                fi

              elif [[ "$days_until_expiration" -le $EXPIRATION_WARNING_DAYS ]]; then
                # Skip renewal emails for workshop instances (expiration <= 7 days)
                # Workshop instances are temporary and not meant to be renewed
                # Use bc for floating-point comparison
                if (( $(echo "$expiration_days <= 7" | bc -l) )); then
                  echo "Skipping renewal email for workshop instance ${instance_name} (expires in ${expiration_days} days)"
                else
                  echo "Instance ${instance_name} will expire soon. Sending warning..."
                  gh issue comment "$issue_number" \
                    --body '⚠️ Instance and volume will be deleted in '"$days_until_expiration"' days. Request an extension using the `renew` command if needed.'
                  set +e
                  gh workflow run send-renewal-email.yml \
                    -f issue_number=$issue_number \
                    -f days_until_expiration=$days_until_expiration
                  error_code=$?
                  set -e
                  if [[ $error_code -ne 0 ]]; then
                    echo "::warning ::Failed to run workflow for sending $instance_name renewal email"
                    gh issue comment "$issue_number" \
                      --body "❌ Failed to send renewal email. See details at https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    continue
                  fi
                fi
              fi
            else
              echo "Skipping Instance $instance_name. Not associated with any 'expiration' labels. Created: [$created_at], Lifespan: [$lifespan_days days]"
            fi
          done
        env:
          OS_CLOUD: ${{ vars.MORPHOCLOUD_OS_CLOUD }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GH_REPO: ${{ github.repository }}
          PREFIX: ${{ vars.INSTANCE_NAME_PREFIX }}
          SUFFIX: ${{ vars.VOLUME_NAME_SUFFIX }}
          EXPIRATION_WARNING_DAYS: 7
